<html>
<head>
</script>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta charset="utf-8">
	<title>polyfill-service test director</title>

	<style>
		* { box-sizing: border-box; }
		html, body { width: 100%; height: 100%; padding:0; margin: 0; }
		textarea { position: absolute; bottom: 0; left: 0; width: 100%; height:196px; resize: none; z-index: 2; font-size: 14px; font-family: monospace; border: 0; background-color:rgba(255,255,255,0.7); padding: 3px 10px;}
		iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index:1; }
	</style>

	<script>
		var runner, rawqs, qs = {}, i, x, timer,
			globalresults = {
				passed: 0,
				failed: 0,
				total: 0,
				duration: 0,
				tests: [],
				failingSuites: {},
				testedSuites: [],
				uaString: 'unknown'
			},
			queue = {{{featuresList}}},
			remainingCount = queue.length
		;
		window.onload = function() {
			runner = document.getElementById('runner');
			if (queue.length) {
				executeTest();
			} else {
				log('No features to test');
			}
		};

		function executeTest() {
			var feature = queue.pop();
			var url = '/test/tests?feature='+feature;
			log('Loading '+url);
			runner.src = url;
			timer = setTimeout(receiveTestResults, 5000);
		}

		function receiveTestResults(featureList, results) {
			clearTimeout(timer);
			if (!featureList) {
				log("Timeout");
			} else {
				if (results.passed) globalresults.passed += results.passed;
				if (results.failed) globalresults.failed += results.failed;
				if (results.total) globalresults.total += results.total;
				if (results.duration) globalresults.duration += results.duration;
				if (results.tests) globalresults.tests = globalresults.tests.concat(results.tests);
				if (results.testedSuites) globalresults.testedSuites = globalresults.testedSuites.concat(results.testedSuites);
				if (results.uaString) globalresults.uaString = results.uaString;
				if (results.failingSuites) {
					for (var f in results.failingSuites) {
						if (results.failingSuites.hasOwnProperty(f)) {
							globalresults.failingSuites[f] = results.failingSuites[f];
						}
					}
				}
				log('Test data received for '+featureList.join(', ')+': '+results.passed+' pass, '+results.failed+' fail.');
			}
			remainingCount = queue.length;

			if (!remainingCount) {
				log('All tests complete, result data populated.  Total: '+globalresults.passed+' pass, '+globalresults.failed+' fail.');
				window.global_test_results = globalresults;
			} else {
				log(remainingCount + ' test(s) remain.');
				executeTest();
			}
		}

		function log(str) {
			var t = new Date();
			var el = document.getElementById('log');
			el.value += '\n' + ((t.getHours()<10)?'0':'') + t.getHours() + ":" + ((t.getMinutes()<10)?'0':'') + t.getMinutes() + ":" + ((t.getSeconds()<10)?'0':'') + t.getSeconds() + ' ' + str;
			el.scrollTop = 99999999;
		}
	</script>
</head>
<body>
	<iframe id='runner'></iframe>
	<textarea id='log'></textarea>
</body>
</html>
