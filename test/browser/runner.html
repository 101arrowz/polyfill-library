<html>
<head>
  <meta charset="utf-8">
  <title>{{feature}} - Mocha test suite for polyfill-service</title>

  <!-- Test and expectation libraries -->
  <link rel="stylesheet" href="/test/libs/mocha/mocha.css" />
  <script src="/test/libs/mocha/mocha.js"></script>
  <script src="/test/libs/should/should.js"></script>

  <!-- Initalise Mocha (overridden if running under Phantom with grunt-mocha) -->
  <script>mocha.setup('bdd')</script>

  {{#loadPolyfill}}
    <!-- Code under test -->
    <script src='/v1/polyfill.js{{#feature}}?features={{feature}}{{/feature}}'></script>
  {{/loadPolyfill}}

  <!-- Tests -->
  <script>
  {{#features}}
    describe("{{feature}}", function() {
      {{#detect}}
        it("passes a basic feature detect", function() {
          var result = !!({{{.}}});
          result.should.be.true;
        });
      {{/detect}}
      {{#tests}}
        {{{.}}}
      {{/tests}}
    });
  {{/features}}
  </script>

</head>
<body>

  <div id="mocha"></div>

  <script>

    // During the test run, surface the test results in Sauce Labs' preferred format
    function run() {
      var runner = mocha.run();
	  var results = {
		  passed: 0,
		  failed: 0,
		  total: 0,
		  duration: 0,
		  tests: [],
		  failingSuites: {},
		  passingSuites: {}
	  };

      runner.on('pass', function(test) {
        results.passed++;
        results.total++;

      });

      runner.on('fail', function(test, err) {

		// Get a set of all the suites with failing tests in them.
		if (test.parent && test.parent.title) {
			results.failingSuites[test.parent.title] = true;
		}

        results.failed++;
        results.total++;
        results.tests.push({
          name: test.fullTitle(),
          result: false,
          message: err.message,
          stack: err.stack
        });
      });

      runner.on('end', function() {
        window.global_test_results = results;
      });
    }

    // If using Phantom, test is kicked off by remote code injection.  If not, run automatically on load.
    if (!("PHANTOMJS" in window)) window.onload = run;

  </script>
</body>
</html>
